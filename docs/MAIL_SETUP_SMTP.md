# Mail Setup (SMTP)

This project sends emails via SMTP using `nodemailer`.

## Environment Variables

Configure the following in `.env.local` or your environment:

- `SMTP_HOST`: SMTP server host (e.g., `smtp.sendgrid.net`)
- `SMTP_PORT`: `587` for STARTTLS or `465` for SSL
- `SMTP_SECURE`: `false` for 587, `true` for 465
- `SMTP_USER`: SMTP username (or API key user for providers)
- `SMTP_PASS`: SMTP password or API key
- `NOTIFY_FROM_EMAIL`: From address, e.g., `"Cotoka" <no-reply@cotoka.jp>`

See `.env.local.example` for a starter template.

## Health Check

- `GET /api/health/email` verifies SMTP connectivity (`transporter.verify()`).
- Returns JSON indicating whether SMTP configuration is present and verification passed.

Example:

```bash
curl -s http://localhost:3000/api/health/email
```

## Dev Test Endpoint

- Only available in development: `/api/dev/test-email`
- `GET /api/dev/test-email?to=you@example.com` sends a simple test email via SMTP.
- `POST /api/dev/test-email` keeps retry and event logging for more involved tests.

## Admin Resend

- `POST /api/admin/email/resend` supports `confirmation`, `cancel`, `24h`, `2h` kinds.
- Emails are sent via SMTP and events record `provider: "smtp"`.

## Attachments

- Confirmation emails include an ICS calendar attachment when generated by the renderer.
- Reminder emails can include attachments when provided by the renderer.

## Troubleshooting

- Ensure `SMTP_HOST`, `SMTP_USER`, `SMTP_PASS` are set; otherwise the server throws early.
- For port `587`, set `SMTP_SECURE=false`; for `465`, set `SMTP_SECURE=true`.
- Check application logs for `email_sent` and `email_send_failed` events.