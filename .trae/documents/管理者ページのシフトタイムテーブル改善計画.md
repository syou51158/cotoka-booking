## 目的
管理者ページのシフト管理を、視覚的に直感的なタイムテーブルUIへ改善し、クリック/ドラッグで作成・移動・伸縮できる操作性と、衝突検知・バルク編集・見やすい表現を実現します。

## 現状（確認）
- 週次グリッド＋フォームCRUDが中心（/admin/shifts）。ドラッグ＆ドロップ未対応。
- 営業時間・休業日・スロット間隔などはフォーム設定（/admin/schedule）。
- APIはシフトCRUDが揃っている（GET/POST/PUT/DELETE）。`verifyAdmin`で保護。
- 予約用カレンダーUIは顧客向け `slot-selector.tsx` にある（週送り・スタッフ切替・空き枠クリック）。

## 追加すると良い機能
- コア操作
  - クリックで新規シフト作成（開始→終了までドラッグでレンジ選択）。
  - ドラッグで移動、上下方向のリサイズで時間変更（スナップ5/15分）。
  - 複数選択・まとめ移動/削除・コピー/ペースト・テンプレート適用（例: 定型休憩）。
- 表示/操作性
  - スタッフ別カラム表示、ブース/部屋別レーン切替、色分け（休憩/通常/予約あり）。
  - ズーム（5/10/15/30分グリッド）、日/週表示の切替、フィルタ（スタッフ/タグ）。
  - ツールチップ/コンテキストメニュー/インライン編集、アクセシビリティ/キーボード操作。
- 品質/安全性
  - 衝突検知（同スタッフの時刻重複をクライアント・サーバー両面で警告）
  - 業務ルールチェック（営業時間外、休業日、臨時営業日との矛盾を警告）
  - Undo/Redo（ローカル履歴）、変更の確定/破棄、楽観更新＋サーバ再検証。
- 通知/連携
  - 変更内容のサマリ（メール/Slack）
  - ICS書き出し/購読（管理用個別カレンダー）
  - 印刷・CSVエクスポート、月次レポート/工数レポート。
- 権限・監査
  - ロール（管理者/編集者/閲覧者）と操作制限。
  - 監査ログ（誰がいつ何を変更）。

## 技術方針
- UI構築
  - 既存のスタック（React/Tailwind/date-fns/Radix）を活かしたカスタムD&D（pointer/mouse/touch）で実装。
  - 代替案: DnDライブラリ採用（`@dnd-kit` 等）も可能だが、現行依存に合わせまずは自前実装を提案。
- データ連携
  - 既存API（`/api/admin/shifts`、`/api/admin/shifts/:id`）を使用。
  - PUTによる時間更新、DELETEによる削除、POSTによる新規作成に集約。
- バリデーション
  - クライアント: 同スタッフ同時間帯の重複チェック、営業時間/休業日/臨時日との整合性チェック。
  - サーバ: 既存 `src/server/shifts.ts` の重複検知を活用。`revalidateTag("shifts")` で最新化。
- パフォーマンス
  - 仮想化（時間スロットの表示最適化）、メモ化、デバウンス更新、最小差分PUT送信。
  - `Asia/Tokyo` 時間帯一貫性維持。

## 実装計画（段階）
1. コンポーネント基盤
   - `AdminTimetable`（週ビュー）を `src/app/admin/(protected)/shifts` に追加。
   - スタッフごと縦カラム、時間軸は横/縦いずれかで視認性重視（スクリーンショットに近い縦時間/横スタッフ）。
   - グリッド生成（5/15/30分スナップ）と週移動、スタッフフィルタを既存機能と連携。
2. CRUD操作のUI化
   - クリックでレンジ開始→ドラッグで終了確定→POST。
   - ドラッグ移動→開始/終了更新→PUT。
   - リサイズハンドル→終了/開始のみ更新→PUT。
   - 選択/削除→DELETE（確認ダイアログ）。
3. ルール・衝突検知
   - フロントで重複検知（同スタッフ×同時間帯）。
   - 営業時間/休業日の反映（`getOpeningHours`/`getDateOverrides` を取得して背景表示、矛盾時警告）。
4. UI改善
   - 色分けとレジェンド、ズーム、日/週切替、ツールチップ/インライン編集、キーボード操作。
   - 印刷フレンドリーCSS、CSV/ICS出力ボタン。
5. 監査/ロール（任意）
   - 操作イベントを監査ログへ記録。
   - ロールに応じて編集可否を制御。
6. テスト/検証
   - 時間帯スナップ、衝突検知、API更新のE2E検証。
   - モバイルタッチ操作の確認、アクセシビリティチェック。

## 既存コードの接続ポイント
- ページ: `src/app/admin/(protected)/shifts/page.tsx`（新コンポーネントを組み込み）
- データ: `src/server/shifts.ts`（重複検知/CRUD）、`src/server/admin.ts`（営業時間/臨時日）
- API: `src/app/api/admin/shifts/*`（PUT/DELETE/POSTをそのまま利用）
- 顧客カレンダー参考: `src/components/booking/slot-selector.tsx`

## 成果物
- 直感的なタイムテーブルUI（クリック/ドラッグ/リサイズ対応）
- 衝突検知と業務ルール警告、ズーム/フィルタ/色分け
- エクスポート（CSV/ICS）と印刷用レイアウト

この計画で実装に進めてもよろしいですか？