## 目的
- 予約・決済・通知・管理を本番同等の信頼性で運用できる完成度へ引き上げる
- 開発と本番の挙動差（モック/設定/認証）を解消し、再現性と保守性を担保

## 重点領域
- 本番パリティ（モック/設定の統一）
- メール通知（dry_run/テンプレート/配信運用）
- 管理UIと認証（Supabase Auth/RBAC/RLS）
- 予約ライフサイクル（リスケ/在庫/同時更新/整合性）
- 決済フロー（Webhook/整合性/リトライ/返金）
- セキュリティ（検証/レート制限/CRON保護/Allowed Hosts）
- 観測性（ログ/トレース/エラーハンドリング）
- 品質保証（E2E/統合テスト/スモーク）

## フェーズ別計画
### フェーズ1: ベースライン安定化
- `.env.local` の必須変数を `src/lib/env.ts` に沿って再確認し、起動時検証を明確化
- ポートは常に `3000`。競合時は再起動で復帰する運用メモを `LOGS.md` に統一（既存記載の整理）
- `src/app/api/health/route.ts` があればヘルス確認を運用導線に追加
- `npm run smoke` を開発の標準チェックに採用（失敗時のトリアージ表を追記）

### フェーズ2: 本番パリティ統一
- モック制御を一箇所に集約（`ALLOW_DEV_MOCKS` と `source=mock` の規約を統一）。`src/app/api/slots/route.ts` など既存分岐を準拠化
- すべての開発用エンドポイントを `src/app/api/dev/**` に限定し、本番ビルドから除外または認証ガード
- `X-Data-Source` ヘッダの付与/検証を共通ミドルウェア化し、レスポンスに反映
- ENV不足時のHTTPステータス規約を共通化（400/422/500の基準）

### フェーズ3: メール通知の完成
- SMTP未設定時は「dry_run」で送信内容を構造化ログ＋DB/ファイルに記録（実装と `docs/prod-parity-audit.md` の整合）
- 予約確認メールのテンプレート化（HTML/テキスト）とプレビュー `src/app/dev/email/preview/confirmation/[rid]/page.tsx` の運用整備
- 配信チャネル拡張の下準備（SMSベンダ抽象化/通知ポリシー）
- バウンス・再送・言語テンプレートの管理方針を `src/server/notifications.ts` 周辺に確立

### フェーズ4: 管理UI + 認証
- Supabase Authによるサインイン・ロール付与（Admin/Staff/User）とルートガード
- RLSポリシーの整備（予約/支払い/通知のテーブルに対して最小権限）
- 管理ページ `/manage` の拡張（検索/フィルタ/手動リスケ/手動通知/エクスポート）
- 操作監査ログ（誰がいつ何を変更したか）を共通記録

### フェーズ5: 予約ライフサイクル強化
- リスケジューリングの確立（在庫再計算/旧予約のキャンセル・再予約/通知連動）
- 同時更新対策（在庫ロック/Stripe支払いと在庫の二相整合/冪等キー）
- スロット生成・更新パイプラインの整理（手動/自動/インポート）

### フェーズ6: 決済の堅牢化
- Stripe Webhookの検証・再送ハンドリング・署名検証・一貫性チェック
- 決済失敗のリトライ戦略とユーザ通知
- 返金/部分返金の管理UI・監査

### フェーズ7: セキュリティ強化
- すべてのAPI入力を `zod` で検証、エラー分類を共通化
- レート制限（IP/ユーザ/エンドポイント単位）とドメイン制限（`ALLOWED_BASE_HOSTS`）をミドルウェア化
- CRONルートの保護（定数時間比較/UA検証/必要ならIP制限）を全CRON系に適用
- 秘密情報の取り扱いガイド徹底（ログ禁止・権限分離・ローテーション）

### フェーズ8: 観測性・運用
- Sentryのスコープ設定/ユーザタグ/リリースタグの統一
- 構造化ログ（JSON）と相関ID、主要ドメイン操作のイベント化
- 可用性のメトリクス（API成功率・遅延・エラー率）をダッシュボード化

### フェーズ9: 品質保証（テスト）
- E2Eテスト（Playwright）で主要UXを自動化（予約→決済→通知→管理操作）
- 統合テストで API 層を網羅（モックと本番設定の両方）
- スモークテストをCIに組み込み、失敗時の通知

## 検証基準（抜粋）
- `npm run dev` で `http://localhost:3000` 正常起動、`/api/health` 成功
- 予約→決済→通知の一連が、モックOFF/ONで同じインタフェース・結果整合
- 管理UIが認証・権限に基づき表示/操作制限される
- 失敗系（ENV不足/支払い失敗/在庫枯渇）が想定どおりに処理・記録
- Lint/Typecheck/E2E/統合/スモークがすべて緑

## 優先度と着手順
1) フェーズ1→2（基盤とパリティ）
2) フェーズ3（通知）と4（認証/管理）を並行
3) フェーズ5→6（ライフサイクルと決済の堅牢化）
4) フェーズ7→8→9（セキュリティ/観測/テストの仕上げ）

## 参考ファイル
- `src/lib/env.ts`, `src/app/api/**/route.ts`, `src/server/**.ts`
- `src/app/dev/**`, `scripts/smoke.ts`
- `.env.local`, `README.md`, `docs/**`, `LOGS.md`

この計画に沿って順番に実装・検証していけば、開発/本番の挙動差を解消しつつ、予約・決済・通知・管理の全体品質を本番水準へ到達できます。