## 目的
予約台帳タイムテーブル上で予約・シフトを直感的に操作（ドラッグ&ドロップ移動、上下リサイズ、長押し編集）できるようにし、過去の重複データを可視化・整理しつつ、今後の重複発生をサーバー側でも防止します。

## 機能仕様（UI/操作）
- ドラッグ&ドロップ移動
  - 予約・シフトブロックを縦方向ドラッグで開始/終了時刻を移動（スナップ=サイト設定の枠間隔）。
  - 予約は「確定/支払い済み」時に移動前に警告（顧客通知が必要なため）。
- 上下リサイズ
  - 上/下ハンドルで終了・開始時刻を調整（スナップ適用）。
- 長押し編集（モーダル）
  - 長押しで編集モーダルを開く（サービス/スタッフ/日時/メモ/ステータスを変更）。
  - 保存時に競合検知→重複があればエラーと視覚警告。
- ビジュアル
  - 重複アイテムは赤リング/ストライプ背景で即時警告（タイムテーブル上）。
  - 営業時間外は背景グレーで作成/移動不可。休業日は全面「休業日」。
  - キーボード操作（↑↓で5/15分移動、Shift+↑↓でリサイズ）。

## データ連携/サーバーAPI
- 既存活用
  - 予約取得: `getAdminReservations({ from,to,staffId,serviceId,status })`
  - 営業時間: `getOpeningHours()`、枠間隔: `getSiteSettings()`
- 新規API（管理者用）
  - `PUT /api/admin/reservations/:id`（開始/終了/スタッフ/メモ更新、`hasConflict` と同等の重複チェックを実装）
  - `POST /api/admin/reservations/reassign`（スタッフ変更＋競合検知）
  - 変更監査ログ記録（誰がいつ何を変更）
- シフト更新は既存 `PUT /api/admin/shifts/:id` を継続使用。

## DB健全性/重複防止
- サーバー側競合検知強化
  - 更新系APIでも `hasConflict` 相当のチェックを必須化。
- DDL排他制約（推奨）
  - Postgresの排他制約（GiST）で「同一スタッフ×時間帯の重複」を不可にする。
  - 例: `EXCLUDE USING gist (staff_id WITH =, tsrange(start_at, end_at, '[]') WITH &&)`（必要に応じて `btree_gist` 有効化）。
- 一括クリーンアップ機能
  - 管理画面に「重複検出」ビューを追加し、重複予約/シフトの一覧・ソート・削除/結合（安全確認付き）。

## UI実装詳細
- タイムテーブル拡張
  - 既存のドラッグ/リサイズ処理を予約にも拡張（現在はシフト対応済み）。
  - 長押し（500ms）で編集モーダル表示（フォームは既存コンポーネント準拠）。
- 競合視覚化
  - スタッフ列で、同時間帯に予約が存在する場合に赤リング表示（現在は実装済みの重なり検知を改善）。
- アクセシビリティ
  - フォーカスリング、キーボードショートカット、ARIA属性付与。

## 段階導入
1. 予約ドラッグ/リサイズのクライアント動作＋管理API `PUT /api/admin/reservations/:id`（競合検知）
2. 長押し編集モーダル（サービス/スタッフ/日時/メモ/ステータス）
3. 重複検出ビュー（一覧→解消）
4. DDL排他制約を適用（開発→ステージ→本番順）

## 検証
- 当日/任意日で予約・シフト移動/編集が正しく反映される
- 重複発生時にフロント警告＋サーバーで更新拒否となる
- 営業時間外/休業日では操作不可である
- 監査ログに変更が記録される

## 期待効果
- 視覚的操作で運用効率を向上
- 過去データの重複整理と将来の重複防止でミス/混乱を削減

この計画で実装を進めます。ご承認いただければ着手します。